<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sri YogaBala Snacks Corner</title>
  <meta name="theme-color" content="#0f172a">

  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:Arial,sans-serif;background:#f4f4f4;padding:10px;}
    .container {max-width:1200px;margin:0 auto;}

    /* Top header with logo */
    .top-header {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin:10px 0 0 0;
    }
    .top-header img {
      height:50px;
      width:50px;
      object-fit:contain;
    }
    .top-header h1 {
      font-size:22px;
      text-align:center;
      color:#333;
    }

    h2 {text-align:center;color:#333;margin:20px 0;}

    .mode-toggle {background:white;padding:20px;border-radius:15px;margin:20px 0;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .mode-buttons {display:flex;gap:15px;justify-content:center;flex-wrap:wrap;}

    .mode-btn {
      padding:12px 25px;
      border:none;
      border-radius:25px;
      cursor:pointer;
      font-size:16px;
      font-weight:bold;
      transition:all 0.2s;
      box-shadow:0 0 0 0 rgba(0,0,0,0);
    }
    .mode-btn.eat {background:#28a745;color:white;}
    .mode-btn.parcel {background:#ffc107;color:#333;}
    .mode-btn.active {
      transform:scale(1.05);
      box-shadow:0 0 15px 3px rgba(0,200,0,0.6);
    }
    .mode-btn.parcel.active {
      box-shadow:0 0 15px 3px rgba(255,193,7,0.7);
    }

    .totals {display:flex;justify-content:space-around;margin:15px 0;background:#f8f9fa;padding:15px;border-radius:10px;}
    .total-box {text-align:center;}
    .total-label {font-size:14px;color:#666;}
    .total-value {font-size:28px;font-weight:bold;color:#28a745;margin:5px 0;}

    .menu-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;margin:20px 0;}
    .menu-item {background:white;border-radius:15px;padding:15px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.3s;position:relative;}
    .menu-item:hover {transform:translateY(-5px);}
    .menu-item img {width:100%;height:130px;object-fit:cover;border-radius:10px;}
    .item-name {font-weight:bold;margin:10px 0;font-size:16px;}
    .prices {display:flex;justify-content:space-between;font-size:14px;}
    .eat-price {color:#28a745;}
    .parcel-price {color:#ffc107;}
    .controls {position:absolute;top:10px;left:10px;right:10px;opacity:0;transition:all 0.3s;}
    .menu-item.active .controls {opacity:1;}
    .qty-controls {display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.9);color:white;padding:15px;border-radius:10px;}
    .qty-btn {background:#007bff;color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;margin:0 5px;}
    .qty-btn:hover {background:#0056b3;}
    .qty-count {font-size:28px;font-weight:bold;background:white;color:black;padding:10px 20px;border-radius:10px;}

    #log-sale {background:#28a745;color:white;border:none;padding:18px 40px;font-size:20px;border-radius:30px;cursor:pointer;margin:20px auto;display:block;}
    #log-sale:hover {background:#218838;}

    .admin {background:white;padding:25px;border-radius:15px;margin:20px 0;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .admin-form {display:flex;flex-wrap:wrap;gap:15px;align-items:end;}
    input, select {padding:12px;border:1px solid #ddd;border-radius:8px;flex:1;min-width:150px;}
    .admin-btn {background:#ffc107;color:#333;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;font-weight:bold;}
    .admin-btn:hover {background:#e0a800;}

    .menu-list {margin-top:20px;}
    .menu-list-row {display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;margin:5px 0;gap:10px;}
    .menu-list-info {flex:1;}
    .menu-list-actions {display:flex;gap:10px;}
    .delete-btn,.edit-btn {border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:13px;}
    .delete-btn {background:#dc3545;color:white;}
    .edit-btn {background:#17a2b8;color:white;}

    .reports {background:white;padding:25px;border-radius:15px;margin:20px 0;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .tabs {display:flex;gap:10px;margin-bottom:20px;justify-content:center;flex-wrap:wrap;}
    .tab {padding:12px 20px;border:none;background:#ddd;cursor:pointer;border-radius:8px;font-weight:bold;}
    .tab.active {background:#007bff;color:white;}

    table {width:100%;border-collapse:collapse;margin-top:15px;}
    th,td {padding:12px;text-align:left;border-bottom:1px solid #eee;}
    th {background:#f8f9fa;font-weight:bold;}
    .order-row {background:#e8f5e8;}
    .total-row {background:#d4edda;font-weight:bold;}

    .small-btn {padding:5px 10px;font-size:12px;border-radius:4px;border:none;cursor:pointer;background:#6c757d;color:white;}
    .small-btn.del-sale {background:#dc3545;color:white;}

    #export-excel {background:#17a2b8;color:white;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;margin-top:15px;}
    #print-a4 {background:#007bff;color:white;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;margin-top:15px;margin-left:10px;}
    #reset-app {background:#dc3545;color:white;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;margin-top:15px;margin-left:10px;}
@media print {
  #customer-bill {
    width: 210mm;
    min-height: 297mm;  /* fill one A4 page */
  }
}

    @media (max-width:768px) {
      .admin-form {flex-direction:column;}
      .tabs {flex-direction:column;align-items:center;}
      .totals {flex-direction:column;gap:10px;}
      .top-header {flex-direction:column;}
    }
    @media print {
  body * { visibility: hidden !important; }
  #a4-report, #a4-report * {
    visibility: visible !important;
  }
  #a4-report {
    position: absolute;
    left: 0;
    top: 0;
    width: 210mm;
    min-height: 297mm;
    padding: 10mm;
    background: white;
  }
  @page {
    size: A4;
    margin: 0;
  }
  table { page-break-inside: auto; }
  tr    { page-break-inside: avoid; page-break-after: auto; }
}

  </style>
</head>
<body>
  <div class="container">
    <!-- Web header with logo + shop name -->
    <div class="top-header">
      <img id="ui-logo" src="logo.png" alt="Logo">
      <h1>Sri YogaBala Snacks Corner, Panruti</h1>
    </div>

    <!-- Mode & current bill totals -->
    <div class="mode-toggle">
      <div class="mode-buttons">
        <button class="mode-btn eat active" data-mode="eat">üçΩÔ∏è Eat</button>
        <button class="mode-btn parcel" data-mode="parcel">üì¶ Parcel</button>
      </div>
      <div>Select Eat OR Parcel for each item (mixed totals auto-calculate)</div>
      <div class="totals">
        <div class="total-box">
          <div class="total-label">Eat Total</div>
          <div class="total-value" id="eat-total">‚Çπ0</div>
        </div>
        <div class="total-box">
          <div class="total-label">Parcel Total</div>
          <div class="total-value" id="parcel-total">‚Çπ0</div>
        </div>
        <div class="total-box">
          <div class="total-label">Grand Total</div>
          <div class="total-value" id="grand-total">‚Çπ0</div>
        </div>
      </div>

      <!-- Advanced Billing Controls -->
      <div style="background:#fff;padding:15px;border-radius:10px;margin-top:10px;display:grid;gap:10px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <input type="number" id="gst-percent" placeholder="GST %">
          <select id="discount-type">
            <option value="">No Discount</option>
            <option value="flat">Flat Discount</option>
            <option value="percent">% Discount</option>
          </select>
          <input type="number" id="discount-value" placeholder="Discount value">
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <select id="payment-mode">
            <option value="CASH">Cash</option>
            <option value="UPI">UPI</option>
            <option value="CARD">Card</option>
            <option value="SPLIT">Split Payment</option>
          </select>
          <input type="text" id="customer-phone" placeholder="Customer Phone (optional)">
        </div>

        <div id="split-area" style="display:none;">
          <small>Split payment: fill amounts per mode (optional)</small>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:5px;">
            <input type="number" id="split-cash" placeholder="Cash ‚Çπ">
            <input type="number" id="split-upi" placeholder="UPI ‚Çπ">
            <input type="number" id="split-card" placeholder="Card ‚Çπ">
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:14px;">
          <span id="billing-summary-label">Gross Total:</span>
          <span id="billing-summary-value">‚Çπ0.00</span>
        </div>
      </div>
    </div>

    <!-- Menu items -->
    <div id="menu-grid" class="menu-grid"></div>

    <!-- Log sale -->
    <button id="log-sale">‚úÖ Log Mixed Sale</button>

    <div style="text-align:center;margin-top:10px;">
      <button class="small-btn" onclick="previewBill()">üëÅÔ∏è Print Preview</button>
      <button class="small-btn" onclick="reprintLastBill()">üßæ Reprint Last Bill</button>
    </div>

    <div style="text-align:center;font-size:18px;margin:10px;">
      <span id="date"></span> | <span id="time"></span>
    </div>

    <!-- Admin: Add/Update items -->
<div class="admin">
  <h2>üîß Add / Update Menu Item</h2>
  <div class="admin-form">
    <input type="url" id="image-url" placeholder="Paste image URL here (https://...)">
    <input type="text" id="name" placeholder="Item Name">
    <input type="number" id="eat-price" placeholder="Eat Price ‚Çπ" step="0.01">
    <input type="number" id="parcel-price" placeholder="Parcel Price ‚Çπ" step="0.01">
    <button class="admin-btn" id="save-btn" onclick="saveItem()">Add Item</button>
  </div>
  <small id="edit-hint" style="color:#666;display:block;margin-top:5px;">
    Tip: Paste image URL (works instantly), click "Edit" on a row below to modify.
  </small>
  <div id="menu-list" class="menu-list"></div>
</div>

    <!-- Reports -->
    <div class="reports">
      <h2>üìä Sales Report</h2>

      <div class="tabs">
        <button class="tab active" onclick="showReport(event,'daily')">Daily Orders</button>
        <button class="tab" onclick="showReport(event,'monthly')">Monthly Orders</button>
        <button class="tab" onclick="showReport(event,'yearly')">Yearly Orders</button>
      </div>
      <table id="report-table">
        <thead>
          <tr>
            <th>Date / Period</th>
            <th>Order #</th>
            <th>Time</th>
            <th>Eat ‚Çπ</th>
            <th>Parcel ‚Çπ</th>
            <th>Total ‚Çπ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="export-excel" onclick="askAndExport()">üì• Export Excel</button>
      <button id="print-a4" onclick="askAndPrint()">üñ®Ô∏è Print A4</button>
      <button id="reset-app">üîÅ Reset All Data</button>
    </div>
  </div>

  <!-- Printable customer bill (thermal) -->
  <div id="customer-bill" style="display:none;padding:5px;">
    <div style="text-align:center;">
      <img id="bill-logo" src="logo.png" alt="Logo" style="max-width:60px;max-height:60px;display:inline-block;margin-bottom:5px;">
      <h3 style="margin:0;">Sri YogaBala Snacks Corner</h3>
      <p id="bill-shop-address" style="font-size:11px;margin:2px 0;">Panruti</p>
      <p id="bill-shop-gst" style="font-size:11px;margin:2px 0;">GSTIN: -</p>
    </div>
    <p style="font-size:12px;">Bill No: <strong>#<span id="bill-id"></span></strong></p>
    <p>Date: <span id="bill-date"></span></p>
    <p>Time: <span id="bill-time"></span></p>
    <hr>
    <div id="bill-items"></div>
    <hr>
    <h4>Total: ‚Çπ<span id="bill-total"></span></h4>
    <p style="text-align:center;font-size:11px;">Thank You üôè Visit Again</p>
  </div>

  <!-- A4 report print container -->
  <div id="a4-report" style="display:none;">
    <div style="text-align:center;margin-bottom:10px;">
      <img id="a4-logo" src="logo.png" style="max-height:60px;max-width:60px;">
      <h2 id="a4-shop-name">Sri YogaBala Snacks Corner</h2>
      <p id="a4-shop-address">Panruti</p>
    </div>

    <h3 id="a4-period-label" style="text-align:center;margin-bottom:10px;"></h3>

    <table id="a4-table" border="1" cellspacing="0" cellpadding="4" style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr>
          <th>Order / Period</th>
          <th>Eat Price</th>
          <th>Parcel Price</th>
          <th>Total Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Totals</th>
          <th id="a4-total-eat"></th>
          <th id="a4-total-parcel"></th>
          <th id="a4-total-grand"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    // ===== INITIAL DATA & GLOBALS =====
    let menu = JSON.parse(localStorage.getItem('menu')) || [
      {id:1,name:'Samosa',eatPrice:3,parcelPrice:3,img:'https://via.placeholder.com/150x130/FF6B6B/FFFFFF?text=Samosa'},
      {id:2,name:'Vada',eatPrice:25,parcelPrice:30,img:'https://via.placeholder.com/150x130/4ECDC4/FFFFFF?text=Vada'},
      {id:3,name:'Bonda',eatPrice:20,parcelPrice:25,img:'https://via.placeholder.com/150x130/45B7D1/FFFFFF?text=Bonda'}
    ];

    let eatOrder = {};
    let parcelOrder = {};
    let sales = JSON.parse(localStorage.getItem('sales')) || [];
    let orderCounter = sales.length + 1;
    let currentMode = 'eat';
    let editingId = null;
    const RESET_PASSWORD = 'owner123';

    let shopProfile = JSON.parse(localStorage.getItem('shopProfile')) || {
      name: 'Sri YogaBala Snacks Corner',
      address: 'Panruti',
      gst: '',
      logo: 'logo.png'
    };

    let lastSale = JSON.parse(localStorage.getItem('lastSale')) || null;

    let currentGST = 0;
    let currentDiscountType = null;
    let currentDiscountValue = 0;
    let currentPaymentMode = 'CASH';
    let currentSplitPayments = [];
    let currentCustomerPhone = '';

    let reportFilter = { from: null, to: null };

    function saveStorage() {
      localStorage.setItem('menu', JSON.stringify(menu));
      localStorage.setItem('sales', JSON.stringify(sales));
      localStorage.setItem('shopProfile', JSON.stringify(shopProfile));
      localStorage.setItem('lastSale', JSON.stringify(lastSale));
    }

    // ===== MENU RENDERING =====
    function renderMenu() {
      const grid = document.getElementById('menu-grid');
      grid.innerHTML = menu.map(item => `
        <div class="menu-item" data-id="${item.id}">
          <img src="${item.img}" alt="${item.name}">
          <div class="item-name">${item.name}</div>
          <div class="prices">
            <span class="eat-price">Eat: ‚Çπ${item.eatPrice}</span>
            <span class="parcel-price">Parcel: ‚Çπ${item.parcelPrice}</span>
          </div>
          <div class="controls" data-id="${item.id}">
            <div class="qty-controls">
              <button class="qty-btn" data-id="${item.id}" data-action="-">-</button>
              <div class="qty-count" data-id="${item.id}">0</div>
              <button class="qty-btn" data-id="${item.id}" data-action="+">+</button>
            </div>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
          this.classList.toggle('active');
          const id = this.dataset.id;
          const count = currentMode === 'eat' ? (eatOrder[id] || 0) : (parcelOrder[id] || 0);
          document.querySelector(`.qty-count[data-id="${id}"]`).textContent = count;
        });
      });

      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const id = this.dataset.id;
          const action = this.dataset.action;
          if (currentMode === 'eat') {
            eatOrder[id] = (eatOrder[id] || 0) + (action === '+' ? 1 : -1);
            if (eatOrder[id] < 0) eatOrder[id] = 0;
            document.querySelector(`.qty-count[data-id="${id}"]`).textContent = eatOrder[id];
          } else {
            parcelOrder[id] = (parcelOrder[id] || 0) + (action === '+' ? 1 : -1);
            if (parcelOrder[id] < 0) parcelOrder[id] = 0;
            document.querySelector(`.qty-count[data-id="${id}"]`).textContent = parcelOrder[id];
          }
          updateTotals();
        });
      });
    }

    function updateTotals() {
      let eatTotal = 0, parcelTotal = 0;
      Object.entries(eatOrder).forEach(([id, qty]) => {
        const item = menu.find(i => i.id == id);
        if (item) eatTotal += item.eatPrice * qty;
      });
      Object.entries(parcelOrder).forEach(([id, qty]) => {
        const item = menu.find(i => i.id == id);
        if (item) parcelTotal += item.parcelPrice * qty;
      });
      document.getElementById('eat-total').textContent = `‚Çπ${eatTotal.toFixed(2)}`;
      document.getElementById('parcel-total').textContent = `‚Çπ${parcelTotal.toFixed(2)}`;
      const grand = eatTotal + parcelTotal;
      document.getElementById('grand-total').textContent = `‚Çπ${grand.toFixed(2)}`;
      recomputeBillingSummary();
    }

    // ===== ADVANCED BILLING =====
    const gstInput = document.getElementById('gst-percent');
    const discountTypeSelect = document.getElementById('discount-type');
    const discountValueInput = document.getElementById('discount-value');
    const paymentModeSelect = document.getElementById('payment-mode');
    const customerPhoneInput = document.getElementById('customer-phone');
    const splitArea = document.getElementById('split-area');
    const splitCashInput = document.getElementById('split-cash');
    const splitUpiInput = document.getElementById('split-upi');
    const splitCardInput = document.getElementById('split-card');
    const billingSummaryLabel = document.getElementById('billing-summary-label');
    const billingSummaryValue = document.getElementById('billing-summary-value');

    function recomputeBillingSummary() {
      const grandText = document.getElementById('grand-total').textContent.replace('‚Çπ','') || '0';
      let base = Number(grandText) || 0;

      currentGST = Number(gstInput.value) || 0;
      currentDiscountType = discountTypeSelect.value || null;
      currentDiscountValue = Number(discountValueInput.value) || 0;

      let discountAmount = 0;
      if (currentDiscountType === 'flat') discountAmount = currentDiscountValue;
      else if (currentDiscountType === 'percent') discountAmount = base * (currentDiscountValue / 100);
      if (discountAmount > base) discountAmount = base;

      let afterDiscount = base - discountAmount;
      let gstAmount = afterDiscount * (currentGST / 100);
      let gross = afterDiscount + gstAmount;

      const rounded = Math.round(gross);

      billingSummaryLabel.textContent = 'Total after GST & discount (rounded):';
      billingSummaryValue.textContent = `‚Çπ${rounded.toFixed(0)}`;

      currentSplitPayments = [];
      if (paymentModeSelect.value === 'SPLIT') {
        const vCash = Number(splitCashInput.value) || 0;
        const vUpi = Number(splitUpiInput.value) || 0;
        const vCard = Number(splitCardInput.value) || 0;
        if (vCash) currentSplitPayments.push({mode:'CASH', amount:vCash});
        if (vUpi) currentSplitPayments.push({mode:'UPI', amount:vUpi});
        if (vCard) currentSplitPayments.push({mode:'CARD', amount:vCard});
      }

      recomputeBillingSummary.lastResult = {
        base,
        discountAmount,
        gstAmount,
        rounded
      };
    }

    gstInput.addEventListener('input', recomputeBillingSummary);
    discountTypeSelect.addEventListener('change', recomputeBillingSummary);
    discountValueInput.addEventListener('input', recomputeBillingSummary);
    paymentModeSelect.addEventListener('change', () => {
      currentPaymentMode = paymentModeSelect.value;
      splitArea.style.display = currentPaymentMode === 'SPLIT' ? 'block' : 'none';
      recomputeBillingSummary();
    });
    customerPhoneInput.addEventListener('input', () => {
      currentCustomerPhone = customerPhoneInput.value.trim();
    });
    [splitCashInput, splitUpiInput, splitCardInput].forEach(inp =>
      inp.addEventListener('input', () => { if (currentPaymentMode === 'SPLIT') recomputeBillingSummary(); })
    );

    function logSale() {
      const eatTotal = Number(document.getElementById('eat-total').textContent.slice(1)) || 0;
      const parcelTotal = Number(document.getElementById('parcel-total').textContent.slice(1)) || 0;
      const grandTotal = eatTotal + parcelTotal;
      if (grandTotal <= 0) return;

      recomputeBillingSummary();
      const billCalc = recomputeBillingSummary.lastResult || {
        base: grandTotal, discountAmount: 0, gstAmount: 0, rounded: grandTotal
      };

      const now = new Date();
      const sale = {
        id: orderCounter++,
        billNo: orderCounter,
        date: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString(),
        eatTotal,
        parcelTotal,
        grandTotal,

        subTotal: billCalc.base,
        gstPercent: currentGST,
        gstAmount: billCalc.gstAmount,
        discountType: currentDiscountType,
        discountValue: currentDiscountValue,
        discountAmount: billCalc.discountAmount,
        roundedTotal: billCalc.rounded,

        paymentMode: currentPaymentMode,
        splitPayments: currentSplitPayments,
        customerPhone: currentCustomerPhone,

        eatItems: Object.entries(eatOrder).filter(([_, q]) => q > 0),
        parcelItems: Object.entries(parcelOrder).filter(([_, q]) => q > 0)
      };

      sales.unshift(sale);
      lastSale = sale;
      saveStorage();

      alert(
        `‚úÖ Bill #${sale.billNo}\n` +
        `Eat: ‚Çπ${eatTotal.toFixed(2)} + Parcel: ‚Çπ${parcelTotal.toFixed(2)} = ‚Çπ${grandTotal.toFixed(2)}\n` +
        `Payable: ‚Çπ${sale.roundedTotal.toFixed(0)} (${sale.paymentMode})`
      );

      eatOrder = {};
      parcelOrder = {};
      currentGST = 0;
      currentDiscountType = null;
      currentDiscountValue = 0;
      currentPaymentMode = 'CASH';
      currentSplitPayments = [];
      currentCustomerPhone = '';
      gstInput.value = '';
      discountTypeSelect.value = '';
      discountValueInput.value = '';
      paymentModeSelect.value = 'CASH';
      splitArea.style.display = 'none';
      customerPhoneInput.value = '';
      splitCashInput.value = '';
      splitUpiInput.value = '';
      splitCardInput.value = '';

      updateTotals();
      renderMenu();
      showReport(null,'daily');

      fillBillDOM(sale);
      if (confirm('Print customer bill?')) {
        printCustomerBill();
      }
    }

    document.getElementById('log-sale').onclick = logSale;

    // ===== MENU CRUD =====
    function saveItem() {
  const imageUrl = document.getElementById('image-url').value.trim();
  const name = document.getElementById('name').value.trim();
  const eatPrice = Number(document.getElementById('eat-price').value);
  const parcelPrice = Number(document.getElementById('parcel-price').value);

  if (!name || isNaN(eatPrice)) {
    alert('Name and Eat Price are required');
    return;
  }

  if (editingId === null) {
    // Add new item
    const id = menu.length ? Math.max(...menu.map(i => i.id)) + 1 : 1;
    menu.push({
      id,
      name,
      eatPrice,
      parcelPrice: isNaN(parcelPrice) ? 0 : parcelPrice,
      img: imageUrl || `https://via.placeholder.com/150x130/FF6B6B/FFFFFF?text=${encodeURIComponent(name)}`
    });
    afterSaveItem();
  } else {
    // Edit existing item
    const index = menu.findIndex(i => i.id === editingId);
    if (index === -1) { alert('Item not found'); return; }
    
    menu[index].name = name;
    menu[index].eatPrice = eatPrice;
    menu[index].parcelPrice = isNaN(parcelPrice) ? 0 : parcelPrice;
    if (imageUrl) menu[index].img = imageUrl; // Only change if URL provided
    
    afterUpdateItem();
  }
}


    function afterSaveItem() {
  saveStorage();
  renderMenu();
  renderList();
  clearForm();  // This now properly resets everything
}

function afterUpdateItem() {
  saveStorage();
  renderMenu();
  renderList();
  clearForm();  // This now properly resets everything
}


    function clearForm() {
  document.getElementById('image-url').value = '';
  document.getElementById('name').value = '';
  document.getElementById('eat-price').value = '';
  document.getElementById('parcel-price').value = '';
  document.getElementById('save-btn').textContent = 'Add Item';  // Reset button text
  document.getElementById('edit-hint').textContent = 'Tip: Paste image URL (works instantly), click "Edit" on a row below to modify that item.';  // Reset hint
  editingId = null;  // CRITICAL: Reset editing mode
}


    function renderList() {
      const list = document.getElementById('menu-list');
      list.innerHTML = menu.map(item => `
        <div class="menu-list-row">
          <div class="menu-list-info">
            <strong>${item.name}</strong> | Eat: ‚Çπ${item.eatPrice} | Parcel: ‚Çπ${item.parcelPrice}
          </div>
          <div class="menu-list-actions">
            <button class="edit-btn" onclick="startEdit(${item.id})">Edit</button>
            <button class="delete-btn" onclick="deleteItem(${item.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

   function startEdit(id) {
  const item = menu.find(i => i.id === id);
  if (!item) return;
  editingId = id;
  document.getElementById('name').value = item.name;
  document.getElementById('eat-price').value = item.eatPrice;
  document.getElementById('parcel-price').value = item.parcelPrice;
  document.getElementById('image-url').value = item.img; // Show current URL
  document.getElementById('save-btn').textContent = 'Update Item';
  document.getElementById('edit-hint').textContent =
    `Editing item #${id} (${item.name}). Paste new image URL or leave blank to keep current.`;
}


    function deleteItem(id) {
      if (!confirm('Delete this menu item?')) return;
      menu = menu.filter(i => i.id !== id);
      saveStorage();
      renderMenu();
      renderList();
    }

    // ===== SHOP PROFILE & BILL HEADER =====
    function applyShopProfileToBill() {
      document.querySelector('#customer-bill h3').textContent = shopProfile.name || 'Sri YogaBala Snacks Corner';
      document.getElementById('bill-shop-address').textContent = shopProfile.address || 'Panruti';
      document.getElementById('bill-shop-gst').textContent =
        shopProfile.gst ? `GSTIN: ${shopProfile.gst}` : '';

      const logoImg = document.getElementById('bill-logo');
      logoImg.src = shopProfile.logo || 'logo.png';
      logoImg.style.display = 'inline-block';

      const uiLogo = document.getElementById('ui-logo');
      if (uiLogo) uiLogo.src = shopProfile.logo || 'logo.png';

      const a4Logo = document.getElementById('a4-logo');
      const a4Name = document.getElementById('a4-shop-name');
      const a4Addr = document.getElementById('a4-shop-address');
      if (a4Logo) a4Logo.src = shopProfile.logo || 'logo.png';
      if (a4Name) a4Name.textContent = shopProfile.name || 'Sri YogaBala Snacks Corner';
      if (a4Addr) a4Addr.textContent = shopProfile.address || 'Panruti';
    }

    function fillBillDOM(sale) {
      applyShopProfileToBill();
      document.getElementById('bill-id').textContent = sale.billNo;
      document.getElementById('bill-date').textContent = sale.date;
      document.getElementById('bill-time').textContent = sale.time;
      document.getElementById('bill-total').textContent = sale.roundedTotal.toFixed(2);

      let itemsHTML = '';
      sale.eatItems.forEach(([id, qty]) => {
        const item = menu.find(i => i.id == id);
        if (item) itemsHTML += `<div>${item.name} x ${qty} = ‚Çπ${(item.eatPrice * qty).toFixed(2)}</div>`;
      });
      sale.parcelItems.forEach(([id, qty]) => {
        const item = menu.find(i => i.id == id);
        if (item) itemsHTML += `<div>${item.name} x ${qty} = ‚Çπ${(item.parcelPrice * qty).toFixed(2)}</div>`;
      });

      itemsHTML += `<hr><div>Sub Total: ‚Çπ${sale.subTotal.toFixed(2)}</div>`;
      if (sale.discountAmount) itemsHTML += `<div>Discount: -‚Çπ${sale.discountAmount.toFixed(2)}</div>`;
      if (sale.gstAmount) itemsHTML += `<div>GST (${sale.gstPercent}%): ‚Çπ${sale.gstAmount.toFixed(2)}</div>`;
      itemsHTML += `<div><strong>Rounded Total: ‚Çπ${sale.roundedTotal.toFixed(0)}</strong></div>`;
      itemsHTML += `<div>Payment: ${sale.paymentMode}</div>`;
      if (sale.customerPhone) itemsHTML += `<div>Phone: ${sale.customerPhone}</div>`;

      document.getElementById('bill-items').innerHTML = itemsHTML;
    }

    function previewBill() {
      if (!lastSale) {
        alert('No bill to preview');
        return;
      }
      fillBillDOM(lastSale);
      const billDiv = document.getElementById('customer-bill');
      billDiv.style.display = 'block';
      alert('Bill preview is visible on screen. Use browser print if needed.');
    }

    function reprintLastBill() {
      if (!lastSale) {
        alert('No bill to reprint');
        return;
      }
      fillBillDOM(lastSale);
      printCustomerBill();
    }

    // ===== REPORTING (Daily / Monthly / Yearly) =====
    function getSales(period) {
      const now = new Date();
      return sales.filter(sale => {
        const saleDate = new Date(sale.date);

        if (reportFilter.from && sale.date < reportFilter.from) return false;
        if (reportFilter.to && sale.date > reportFilter.to) return false;

        switch(period) {
          case 'daily':   return sale.date === now.toISOString().split('T')[0];
          case 'monthly': return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
          case 'yearly':  return saleDate.getFullYear() === now.getFullYear();
          default:        return true;
        }
      });
    }

    function showReport(ev, period) {
      if (ev) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        ev.target.classList.add('active');
      }
      const periodSales = getSales(period);
      let html = '';

      if (period === 'daily') {
        periodSales.forEach(sale => {
          html += `
            <tr class="order-row">
              <td>${sale.date}</td>
              <td>#${sale.id}</td>
              <td>${sale.time}</td>
              <td>‚Çπ${(Number(sale.eatTotal)||0).toFixed(0)}</td>
              <td>‚Çπ${(Number(sale.parcelTotal)||0).toFixed(0)}</td>
              <td>‚Çπ${(Number(sale.roundedTotal)||Number(sale.grandTotal)||0).toFixed(0)}</td>
            </tr>
          `;
        });
      } else {
        // For monthly/yearly: show one summary "row"
        let totalEat = 0, totalParcel = 0, totalGrand = 0;
        periodSales.forEach(x => {
          totalEat += Number(x.eatTotal)||0;
          totalParcel += Number(x.parcelTotal)||0;
          totalGrand += Number(x.roundedTotal)||Number(x.grandTotal)||0;
        });

        const now = new Date();
        let label = '';
        if (period === 'monthly') {
          const monthName = now.toLocaleString('en-IN', {month:'long'});
          label = `${monthName} ${now.getFullYear()}`;
        } else {
          label = `${now.getFullYear()}`;
        }

        html += `
          <tr class="order-row">
            <td>${label}</td>
            <td>‚Äì</td>
            <td>‚Äì</td>
            <td>‚Çπ${totalEat.toFixed(0)}</td>
            <td>‚Çπ${totalParcel.toFixed(0)}</td>
            <td>‚Çπ${totalGrand.toFixed(0)}</td>
          </tr>
        `;
      }

      const totalEat = periodSales.reduce((s,x)=>s+(Number(x.eatTotal)||0),0);
      const totalParcel = periodSales.reduce((s,x)=>s+(Number(x.parcelTotal)||0),0);
      const totalGrand = periodSales.reduce((s,x)=>s+(Number(x.roundedTotal)||Number(x.grandTotal)||0),0);

      html += `
        <tr class="total-row">
          <td><strong>TOTALS</strong></td>
          <td colspan="2">${periodSales.length} orders</td>
          <td><strong>‚Çπ${totalEat.toFixed(0)}</strong></td>
          <td><strong>‚Çπ${totalParcel.toFixed(0)}</strong></td>
          <td><strong>‚Çπ${totalGrand.toFixed(0)}</strong></td>
        </tr>
      `;

      document.querySelector('#report-table tbody').innerHTML =
        html || '<tr><td colspan="6" style="text-align:center;padding:30px;">No sales yet</td></tr>';
    }

    // ===== EXCEL EXPORT + A4 PRINT WITH PERIOD PROMPT =====
    function askPeriod(msg) {
      const choice = prompt(
        msg + '\n1 = Daily\n2 = Monthly\n3 = Yearly'
      );
      if (choice === '1') return 'daily';
      if (choice === '2') return 'monthly';
      if (choice === '3') return 'yearly';
      return null;
    }

    function askAndExport() {
      const period = askPeriod('Select period for Excel export:');
      if (!period) return;
      exportExcel(period);
    }

    function askAndPrint() {
      const period = askPeriod('Select period for A4 print:');
      if (!period) return;
      printA4Report(period);
    }

    function exportExcel(period) {
      const data = getSales(period);

      let csv = 'order_no,eat_price,parcel_price,total_amount\n';
      let totalEat = 0, totalParcel = 0, totalGrand = 0;

      data.forEach(s => {
        const eat = Number(s.eatTotal) || 0;
        const parcel = Number(s.parcelTotal) || 0;
        const total = Number(s.roundedTotal) || Number(s.grandTotal) || 0;
        csv += `${s.id},${eat},${parcel},${total}\n`;
        totalEat += eat;
        totalParcel += parcel;
        totalGrand += total;
      });

      csv += `Totals,${totalEat},${totalParcel},${totalGrand}\n`;

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sales-${period}-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function buildA4Table(period) {
      applyShopProfileToBill();

      const data = getSales(period);
      const tbody = document.querySelector('#a4-table tbody');
      tbody.innerHTML = '';
      let totalEat = 0, totalParcel = 0, totalGrand = 0;

      data.forEach(s => {
        const eat = Number(s.eatTotal) || 0;
        const parcel = Number(s.parcelTotal) || 0;
        const total = Number(s.roundedTotal) || Number(s.grandTotal) || 0;
        totalEat += eat;
        totalParcel += parcel;
        totalGrand += total;
      });

      const now = new Date();
      let label = '';
      if (period === 'daily') {
        label = `Daily Orders ‚Äì ${now.toLocaleDateString('en-IN')}`;
        data.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>#${s.id}</td>
            <td>${Number(s.eatTotal)||0}</td>
            <td>${Number(s.parcelTotal)||0}</td>
            <td>${Number(s.roundedTotal)||Number(s.grandTotal)||0}</td>
          `;
          tbody.appendChild(tr);
        });
      } else if (period === 'monthly') {
        const monthName = now.toLocaleString('en-IN', {month:'long'});
        label = `Monthly Orders ‚Äì ${monthName} ${now.getFullYear()}`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${monthName}</td>
          <td>${totalEat}</td>
          <td>${totalParcel}</td>
          <td>${totalGrand}</td>
        `;
        tbody.appendChild(tr);
      } else if (period === 'yearly') {
        const year = now.getFullYear();
        label = `Yearly Orders ‚Äì ${year}`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${year}</td>
          <td>${totalEat}</td>
          <td>${totalParcel}</td>
          <td>${totalGrand}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('a4-period-label').textContent = label;
      document.getElementById('a4-total-eat').textContent = totalEat;
      document.getElementById('a4-total-parcel').textContent = totalParcel;
      document.getElementById('a4-total-grand').textContent = totalGrand;
    }
function printA4Report(period) {
  buildA4Table(period);
  const a4 = document.getElementById('a4-report');
  a4.style.display = 'block';

  const style = document.createElement('style');
  style.id = 'print-style';
  style.textContent = `
    @media print {
      * { visibility: hidden !important; }
      #a4-report, #a4-report * { visibility: visible !important; }
      
      /* FORCE SINGLE PAGE - CRITICAL */
      @page { 
        size: A4; 
        margin: 0; 
        size: A4 portrait !important;
      }
      
      #a4-report {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        width: 210mm !important;
        height: 297mm !important;  /* EXACT A4 height */
        padding: 10mm !important;
        background: white !important;
        overflow: hidden !important;  /* NO OVERFLOW */
        box-sizing: border-box !important;
      }
      
      /* Kill ALL extra content */
      body::after, body::before, html::after, html::before { display: none !important; }
      table { page-break-inside: avoid !important; }
    }
    
    /* Screen styles don't interfere */
    #a4-report { display: block !important; }
  `;
  document.head.appendChild(style);

  setTimeout(() => {
    window.print();
    setTimeout(() => {
      a4.style.display = 'none';
      const s = document.getElementById('print-style');
      if (s) s.remove();
    }, 100);
  }, 100);
}

function printCustomerBill() {
  if (!lastSale) {
    alert('No bill to print');
    return;
  }
  fillBillDOM(lastSale);
  const billDiv = document.getElementById('customer-bill');

  const style = document.createElement('style');
  style.id = 'bill-print-style';
  style.textContent = `
    @media print {
      * { visibility: hidden !important; }
      #customer-bill, #customer-bill * { visibility: visible !important; }
      
      /* FORCE SINGLE THERMAL PAGE */
      @page { 
        size: auto; 
        margin: 0; 
      }
      
      #customer-bill {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        width: 80mm !important;
        height: 100mm !important;  /* Fixed thermal receipt height */
        padding: 5mm !important;
        font-size: 12px !important;
        background: white !important;
        overflow: hidden !important;
      }
    }
  `;
  document.head.appendChild(style);

  billDiv.style.display = 'block';
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      billDiv.style.display = 'none';
      const s = document.getElementById('bill-print-style');
      if (s) s.remove();
    }, 100);
  }, 100);
}

    // ===== RESET APP =====
    document.getElementById('reset-app').onclick = function () {
      const sure = confirm('Are you sure you want to reset ALL data?');
      if (!sure) return;
      const pwd = prompt('Enter owner password:');
      if (pwd !== RESET_PASSWORD) {
        alert('Wrong password. Reset cancelled.');
        return;
      }
      localStorage.clear();
      menu = [
        {id:1,name:'Samosa',eatPrice:3,parcelPrice:3,img:'https://via.placeholder.com/150x130/FF6B6B/FFFFFF?text=Samosa'},
        {id:2,name:'Vada',eatPrice:25,parcelPrice:30,img:'https://via.placeholder.com/150x130/4ECDC4/FFFFFF?text=Vada'},
        {id:3,name:'Bonda',eatPrice:20,parcelPrice:25,img:'https://via.placeholder.com/150x130/45B7D1/FFFFFF?text=Bonda'}
      ];
      eatOrder = {};
      parcelOrder = {};
      sales = [];
      orderCounter = 1;
      shopProfile = {
        name: 'Sri YogaBala Snacks Corner',
        address: 'Panruti',
        gst: '',
        logo: 'logo.png'
      };
      lastSale = null;
      saveStorage();
      updateTotals();
      renderMenu();
      renderList();
      applyShopProfileToBill();
      showReport(null,'daily');
      alert('All data reset successfully.');
    };

    // ===== DATE & CLOCK =====
    function clock() {
      const now = new Date();
      document.getElementById('date').textContent = now.toLocaleDateString('en-IN');
      document.getElementById('time').textContent = now.toLocaleTimeString('en-IN');
    }
    clock();
    setInterval(clock, 1000);

    // Mode buttons
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.dataset.mode;
      });
    });

    // INIT
    renderMenu();
    renderList();
    updateTotals();
    applyShopProfileToBill();
    showReport(null,'daily');
  </script>
</body>
</html>
